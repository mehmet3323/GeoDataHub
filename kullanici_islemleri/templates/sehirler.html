<!DOCTYPE html>
<html lang="tr">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Su Doluluk Oranlarƒ±</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/sehirler.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
       
    </style>
</head>
<body>
    <!-- √úst Men√º (Navbar) -->
    <div class="navbar">
        <ul class="menu">
            <li><a href="{% url 'home' %}">Ana Sayfa</a></li>
            <li><a href="{% url 'havaKalitesi' %}">Hava Kalitesi</a></li> 
            <li><a href="{% url 'haberler' %}">Haberler</a></li>
            <li><a href="{% url 'hakkimizda' %}">Hakkƒ±mƒ±zda</a></li>
        </ul>
        <div class="search-box">
            <input type="text" placeholder="Arama yap...">
            <button>üîç</button>
        </div>
    </div>

    <div class="content">
        <h1>T√ºrkiye Su Doluluk Oranlarƒ±</h1>
        
        <!-- Harita -->
        <div id="map"></div>

        <!-- Grafik Konteynerƒ± -->
        <div id="charts-container">
            <div class="chart-container">
                <div class="chart-title">Su Doluluk Oranƒ± ve Yƒ±llƒ±k Deƒüi≈üimi</div>
                <canvas id="water-level-chart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // T√ºrkiye'nin merkez koordinatlarƒ±
            const map = L.map('map').setView([39.0, 35.0], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Bilgi kutusu olu≈ütur
            const info = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };

            info.update = function (props) {
                this._div.innerHTML = '<h4>Baraj Doluluk Oranlarƒ±</h4>' +  
                    (props ? `<b>${props.adi}</b><br />Ortalama Doluluk: %${props.doluluk_orani}` : '≈ûehir se√ßiniz');
            };

            info.addTo(map);

            // Su doluluk verilerini almak i√ßin API √ßaƒürƒ±sƒ±
            fetch('/api/su-doluluk/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(sehir => {
                        // √ñzel marker ikonu olu≈ütur
                        const customIcon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                width: 40px;
                                height: 40px;
                                background: ${getColor(sehir.doluluk_orani)};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 12px;
                                color: white;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                border: 2px solid white;
                            ">${sehir.doluluk_orani}%</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20],
                            popupAnchor: [0, -20]
                        });

                        const marker = L.marker([sehir.latitude, sehir.longitude], {
                            icon: customIcon
                        }).addTo(map);

                        // Baraj listesini olu≈ütur
                        const barajListesi = sehir.barajlar.map(baraj => 
                            `<tr>
                                <td>${baraj.ad}</td>
                                <td>%${baraj.oran}</td>
                            </tr>`
                        ).join('');

                        const popupContent = `
                            <div class="popup-content">
                                <h3>${sehir.adi}</h3>
                                <p><strong>Ortalama Doluluk Oranƒ±:</strong> %${sehir.doluluk_orani}</p>
                                <p><strong>Son G√ºncelleme:</strong> ${sehir.son_guncelleme}</p>
                                <table class="baraj-table">
                                    <thead>
                                        <tr>
                                            <th>Baraj Adƒ±</th>
                                            <th>Doluluk Oranƒ±</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${barajListesi}
                                    </tbody>
                                </table>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        
                        marker.on('mouseover', function (e) {
                            this.openPopup();
                            info.update(sehir);
                            // Marker animasyonu - scale deƒüerini doƒürudan div'e uygula
                            const markerDiv = this.getElement().querySelector('div');
                            markerDiv.style.transform = 'scale(1.1)';
                        });
                        
                        marker.on('mouseout', function (e) {
                            this.closePopup();
                            info.update();
                            // Marker animasyonunu sƒ±fƒ±rla - scale deƒüerini normale d√∂nd√ºr
                            const markerDiv = this.getElement().querySelector('div');
                            markerDiv.style.transform = 'scale(1)';
                        });
                    });

                    // Grafik verilerini g√ºncelle
                    updateChart(data);
                })
                .catch(error => {
                    console.error('Veri y√ºkleme hatasƒ±:', error);
                    alert('Baraj verileri y√ºklenirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyiniz.');
                });

            function getColor(doluluk) {
                return doluluk > 75 ? '#27ae60' :  // Koyu ye≈üil
                       doluluk > 50 ? '#f39c12' :  // Turuncu
                       doluluk > 25 ? '#d35400' :  // Koyu turuncu
                                    '#c0392b';     // Koyu kƒ±rmƒ±zƒ±
            }

            function updateChart(data) {
                const ctx = document.getElementById('water-level-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(sehir => sehir.adi),
                        datasets: [{
                            label: 'Su Doluluk Oranƒ± (%)',
                            data: data.map(sehir => sehir.doluluk_orani),
                            backgroundColor: data.map(sehir => getColor(sehir.doluluk_orani)),
                            borderColor: data.map(sehir => getColor(sehir.doluluk_orani)),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Doluluk Oranƒ± (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '≈ûehirlere G√∂re Su Doluluk Oranlarƒ±'
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
